<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ö–∞—Ä—Ç–∞ –ø–∞—Ç—Ä—É–ª–µ–π –î–ü–°</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
    <style>
        body { margin: 0; padding: 0; font-family: Arial, sans-serif; }
        #map { height: 100vh; width: 100%; }
        .info { padding: 10px; background: white; border-radius: 5px; }
        .refresh-btn {
            position: absolute;
            top: 10px;
            right: 10px;
            z-index: 1000;
            padding: 10px 15px;
            background: white;
            border: 2px solid #007bff;
            border-radius: 5px;
            cursor: pointer;
            font-weight: bold;
        }
        .stats {
            position: absolute;
            top: 10px;
            left: 10px;
            z-index: 1000;
            padding: 10px;
            background: white;
            border-radius: 5px;
            border: 2px solid #28a745;
        }
    </style>
</head>
<body>
    <div id="map"></div>
    <button class="refresh-btn" onclick="loadData()">üîÑ –û–±–Ω–æ–≤–∏—Ç—å</button>
    <div class="stats" id="stats">–ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö...</div>

    <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
    <script>
        let map;
        let markers = [];
        let patrolData = [];

        function initMap() {
            // –ù–∞—á–∞–ª—å–Ω—ã–µ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã - –≤–æ–∑—å–º–µ–º –∏–∑ –≤–∞—à–∏—Ö –¥–∞–Ω–Ω—ã—Ö
            map = L.map('map').setView([55.394374, 37.827761], 13);
            
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '¬© OpenStreetMap contributors'
            }).addTo(map);
            
            loadData();
        }

        async function loadData() {
            try {
                console.log('–ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö...');
                
                // –ü—Ä—è–º–∞—è —Å—Å—ã–ª–∫–∞ –Ω–∞ raw —Ñ–∞–π–ª GitHub
                const timestamp = new Date().getTime();
                const response = await fetch(`https://raw.githubusercontent.com/samkurp/samkurp/main/data/patrols_data.json?t=${timestamp}`);
                
                console.log('–°—Ç–∞—Ç—É—Å –æ—Ç–≤–µ—Ç–∞:', response.status);
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const data = await response.json();
                console.log('–ü–æ–ª—É—á–µ–Ω—ã –¥–∞–Ω–Ω—ã–µ:', data);
                
                if (!Array.isArray(data)) {
                    throw new Error('–î–∞–Ω–Ω—ã–µ –Ω–µ —è–≤–ª—è—é—Ç—Å—è –º–∞—Å—Å–∏–≤–æ–º');
                }
                
                patrolData = data;
                updateMap();
                updateStats();
                
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö:', error);
                document.getElementById('stats').innerHTML = '–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö: ' + error.message;
                
                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Ç–µ—Å—Ç–æ–≤—ã–µ –¥–∞–Ω–Ω—ã–µ –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏
                patrolData = [
                  {
                    "user_id": 566632214,
                    "username": "samkurp",
                    "latitude": 55.394374,
                    "longitude": 37.827761,
                    "timestamp": 1757219835.0,
                    "date": "2025-09-07 04:37:15"
                  },
                  {
                    "user_id": 566632214,
                    "username": "samkurp",
                    "latitude": 55.386853,
                    "longitude": 37.775371,
                    "timestamp": 1757220144.0,
                    "date": "2025-09-07 04:42:24"
                  }
                ];
                updateMap();
                updateStats();
                document.getElementById('stats').innerHTML += ' (–∏—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è —Ç–µ—Å—Ç–æ–≤—ã–µ –¥–∞–Ω–Ω—ã–µ)';
            }
        }

        function updateMap() {
            // –£–¥–∞–ª—è–µ–º —Å—Ç–∞—Ä—ã–µ –º–∞—Ä–∫–µ—Ä—ã
            markers.forEach(marker => map.removeLayer(marker));
            markers = [];

            if (patrolData.length === 0) {
                document.getElementById('stats').innerHTML = '–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è';
                return;
            }

            // –î–æ–±–∞–≤–ª—è–µ–º –Ω–æ–≤—ã–µ –º–∞—Ä–∫–µ—Ä—ã
            patrolData.forEach(point => {
                const marker = L.marker([point.latitude, point.longitude])
                    .addTo(map)
                    .bindPopup(`
                        <div class="info">
                            <strong>üöì –ü–∞—Ç—Ä—É–ª—å –î–ü–°</strong><br>
                            –í—Ä–µ–º—è: ${point.date}<br>
                            –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: ${point.username}<br>
                            –ö–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã: ${point.latitude.toFixed(6)}, ${point.longitude.toFixed(6)}
                        </div>
                    `);
                
                markers.push(marker);
            });

            // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –ø—Ä–∏–±–ª–∏–∂–µ–Ω–∏–µ –∫ —Ç–æ—á–∫–∞–º
            if (markers.length > 0) {
                const group = new L.featureGroup(markers);
                map.fitBounds(group.getBounds().pad(0.1));
            }
        }

        function updateStats() {
            const statsElement = document.getElementById('stats');
            if (statsElement) {
                statsElement.innerHTML = `üöì –¢–æ—á–µ–∫ –Ω–∞ –∫–∞—Ä—Ç–µ: ${patrolData.length} | –û–±–Ω–æ–≤–ª–µ–Ω–æ: ${new Date().toLocaleTimeString()}`;
            }
        }

        window.onload = initMap;
        
        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∫–∞–∂–¥—ã–µ 30 —Å–µ–∫—É–Ω–¥
        setInterval(loadData, 30000);
    </script>
</body>
</html>
