<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ö–∞—Ä—Ç–∞ –ø–∞—Ç—Ä—É–ª–µ–π –î–ü–°</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
    <style>
        body { margin: 0; padding: 0; font-family: Arial, sans-serif; }
        #map { height: 100vh; width: 100%; }
        .info { padding: 10px; background: white; border-radius: 5px; }
        .refresh-btn {
            position: absolute;
            top: 10px;
            right: 10px;
            z-index: 1000;
            padding: 10px 15px;
            background: white;
            border: 2px solid #007bff;
            border-radius: 5px;
            cursor: pointer;
            font-weight: bold;
        }
        .stats {
            position: absolute;
            top: 10px;
            left: 10px;
            z-index: 1000;
            padding: 10px;
            background: white;
            border-radius: 5px;
            border: 2px solid #28a745;
        }
        .loading {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            z-index: 1000;
            padding: 20px;
            background: white;
            border-radius: 10px;
            text-align: center;
        }
    </style>
</head>
<body>
    <div id="map"></div>
    <button class="refresh-btn" onclick="loadData()">üîÑ –û–±–Ω–æ–≤–∏—Ç—å</button>
    <div class="stats" id="stats">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
    <div class="loading" id="loading" style="display: none;">–ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö...</div>

    <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
    <script>
        let map;
        let markers = [];
        let patrolData = [];
        const GITHUB_USERNAME = '–í–ê–®_USERNAME'; // –ó–ê–ú–ï–ù–ò–¢–ï –ù–ê –°–í–û–ô
        const GITHUB_REPO = '–í–ê–®_REPO'; // –ó–ê–ú–ï–ù–ò–¢–ï –ù–ê –°–í–û–ô

        function initMap() {
            map = L.map('map').setView([55.7558, 37.6173], 10);
            
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '¬© OpenStreetMap contributors'
            }).addTo(map);
            
            loadData();
        }

        async function loadData() {
            showLoading(true);
            try {
                // –ü—Ä—è–º–∞—è —Å—Å—ã–ª–∫–∞ –Ω–∞ raw —Ñ–∞–π–ª GitHub
                const timestamp = new Date().getTime();
                const response = await fetch(`https://raw.githubusercontent.com/${GITHUB_USERNAME}/${GITHUB_REPO}/main/data/patrols_data.json?t=${timestamp}`);
                
                if (!response.ok) {
                    throw new Error(`–û—à–∏–±–∫–∞ HTTP: ${response.status}`);
                }
                
                const data = await response.json();
                
                if (!Array.isArray(data)) {
                    throw new Error('–î–∞–Ω–Ω—ã–µ –Ω–µ —è–≤–ª—è—é—Ç—Å—è –º–∞—Å—Å–∏–≤–æ–º');
                }
                
                patrolData = data;
                updateMap();
                updateStats();
                
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö:', error);
                document.getElementById('stats').innerHTML = '–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö';
                
                // –ü—Ä–æ–±—É–µ–º –∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω—ã–π –ø—É—Ç—å
                try {
                    const altResponse = await fetch('patrols_data.json');
                    patrolData = await altResponse.json();
                    updateMap();
                    updateStats();
                    document.getElementById('stats').innerHTML = `üöì –¢–æ—á–µ–∫: ${patrolData.length} (–ª–æ–∫–∞–ª—å–Ω—ã–π —Ñ–∞–π–ª)`;
                } catch (altError) {
                    console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ª–æ–∫–∞–ª—å–Ω–æ–≥–æ —Ñ–∞–π–ª–∞:', altError);
                }
            } finally {
                showLoading(false);
            }
        }

        function updateMap() {
            // –£–¥–∞–ª—è–µ–º —Å—Ç–∞—Ä—ã–µ –º–∞—Ä–∫–µ—Ä—ã
            markers.forEach(marker => map.removeLayer(marker));
            markers = [];

            if (patrolData.length === 0) {
                document.getElementById('stats').innerHTML = '–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è';
                return;
            }

            // –î–æ–±–∞–≤–ª—è–µ–º –Ω–æ–≤—ã–µ –º–∞—Ä–∫–µ—Ä—ã
            patrolData.forEach(point => {
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã—Ö –ø–æ–ª–µ–π
                if (point.latitude && point.longitude) {
                    const marker = L.marker([point.latitude, point.longitude])
                        .addTo(map)
                        .bindPopup(`
                            <div class="info">
                                <strong>üöì –ü–∞—Ç—Ä—É–ª—å –î–ü–°</strong><br>
                                –í—Ä–µ–º—è: ${point.date || '–Ω–µ–∏–∑–≤–µ—Å—Ç–Ω–æ'}<br>
                                –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: ${point.username || '–ê–Ω–æ–Ω–∏–º'}<br>
                                –ö–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã: ${point.latitude.toFixed(6)}, ${point.longitude.toFixed(6)}
                            </div>
                        `);
                    
                    markers.push(marker);
                }
            });

            if (markers.length > 0) {
                const group = new L.featureGroup(markers);
                map.fitBounds(group.getBounds().pad(0.1));
            }
        }

        function updateStats() {
            const statsElement = document.getElementById('stats');
            if (statsElement) {
                statsElement.innerHTML = `üöì –¢–æ—á–µ–∫: ${patrolData.length} | –ü–æ—Å–ª–µ–¥–Ω–µ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ: ${new Date().toLocaleTimeString()}`;
            }
        }

        function showLoading(show) {
            const loadingElement = document.getElementById('loading');
            if (loadingElement) {
                loadingElement.style.display = show ? 'block' : 'none';
            }
        }

        window.onload = initMap;
        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∫–∞–∂–¥—ã–µ 30 —Å–µ–∫—É–Ω–¥
        setInterval(loadData, 30000);
    </script>
</body>
</html>
